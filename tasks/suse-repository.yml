- name: fetch suse repo file
  uri:
    url: '{{ item.repo }}'
    return_content: yes
  check_mode: no
  register: pkg_mirror_register_suse_repo_file

- name: parse suse repo file
  set_fact:
    pkg_mirror_icinga_suse_repo_name: '{{ pkg_mirror_register_suse_repo_file.content.splitlines()[0][1:-1] }}'

- name: check if suse repository already exists
  stat:
    path: /etc/zypp/repos.d/{{ pkg_mirror_icinga_suse_repo_name }}.repo
  check_mode: no
  register: pkg_mirror_register_icinga_suse_repo_stat

- name: configure suse repository
  copy:
    dest: /etc/zypp/repos.d/{{ pkg_mirror_icinga_suse_repo_name }}.repo
    content: "{{ pkg_mirror_register_suse_repo_file.content }}"
  when:
    - not pkg_mirror_register_icinga_suse_repo_stat.stat.exists

- name: update suse repo key
  ansible.builtin.rpm_key:
    state: present
    key: "{{ pkg_mirror_register_suse_repo_file.content.splitlines()[5][7:] }}"
  when:
    - not pkg_mirror_register_icinga_suse_repo_stat.stat.exists
